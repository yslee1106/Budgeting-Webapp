<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>
<body>
    <!-- Floating Chat Icon -->
    <div id="chatbot-icon">ðŸ’¬</div>

    <!-- Chatbot Container -->
    <div id="chatbot-container" class="hidden">
        {% csrf_token %}
        <div id="chatbot-header">
            <span>Chatbot</span>
            <button id="close-btn">&times;</button>
        </div>
        <div class="chatbot-body" id="chatbot-body">
            <div id="chatbot-messages"></div>
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chat-input" placeholder="Type a message...">
            <button class="send-btn" id="send-btn">Send</button>
        </div>
    </div>

    <script>
        const chatbotIcon = document.getElementById("chatbot-icon");

        chatbotIcon.addEventListener("click", function () {
            const chatbotContainer = document.getElementById("chatbot-container");
            chatbotContainer.classList.remove("hidden");
            chatbotIcon.style.display = "none"; // Hide chat icon
        });

        // Connect to the WebSocket
        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chatbot/'
        );

        function appendMessage(sender, message) {
            const chat = document.getElementById('chatbot-messages');
            const messageElement = document.createElement("div");
            messageElement.classList.add("message", sender);
            messageElement.textContent = message;
            chat.appendChild(messageElement);
            chat.scrollTop = chatbotMessages.scrollHeight;
        }

        // Handle incoming messages
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            appendMessage("chatbot", data.message)
        };

        // Handle WebSocket errors
        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        // Send a message when the send button is clicked
        document.getElementById('send-btn').onclick = function() {
            const messageInput = document.getElementById('chat-input');
            const message = messageInput.value;
            if (message) {
                chatSocket.send(JSON.stringify({
                    'message': message
                }));
                messageInput.value = ''; // Clear the input field
                appendMessage("user", message)   
            }
        };

        // Send a message when Enter is pressed
        document.getElementById('chat-input').onkeypress = function(e) {
            if (e.key === 'Enter') {
                document.getElementById('send-btn').click();
            }
        };
    </script>
    
</body>
</html>